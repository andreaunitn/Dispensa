<!DOCTYPE html>
<html>
    <head>
        <title>
            La Dispensa
        </title>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link rel="icon" href="https://raw.githubusercontent.com/andreaunitn/Dispensa/cercaRicette/Immagini/forchetta.png">

        <style>
body {font-family: Arial, Helvetica, sans-serif;}
* {box-sizing: border-box;}


        .open-button {
          background-color: #555;
          color: white;
          padding: 16px 20px;
          border: none;
          cursor: pointer;
          opacity: 0.8;
          position: fixed;
          bottom: 23px;
          right: 28px;
          width: 280px;
        }


        .form-popup {
          display: none;
          position: fixed;
          bottom: 0;
          right: 15px;
          border: 3px solid #f1f1f1;
          z-index: 9;
        }


        .form-container {
          max-width: 300px;
          padding: 10px;
          background-color: white;
        }


        .form-container input[type=text], .form-container input[type=password] {
          width: 100%;
          padding: 15px;
          margin: 5px 0 22px 0;
          border: none;
          background: #f1f1f1;
        }


        .form-container input[type=text]:focus, .form-container input[type=password]:focus {
          background-color: #ddd;
          outline: none;
        }



        .form-container .btn {
          background-color: #04AA6D;
          color: white;
          padding: 16px 20px;
          border: none;
          cursor: pointer;
          width: 100%;
          margin-bottom:10px;
          opacity: 0.8;
        }

        .btn1 {
          background-color: #c9d2d4;
          color: black;
          padding: 16px 20px;
          border: none;
          cursor: pointer;
          width: 130px;
          height: 20px;
          opacity: 0.8;
          box-sizing : content-box;
        }

        .form-container .cancel {
          background-color: red;
        }


        .form-container .btn:hover, .open-button:hover {
          opacity: 1;
        }


        .barra_nav {
            background-color: #63bb66;
            display: flex;
            justify-content: center;
            list-style-type: none;
            margin: 0;
            padding: 0;
            overflow: hidden;
            width:100%
        }



            /* Change the link color to #111 (black) on hover */
            li a:hover {
                background-color: #111;
                color: #63bb66;
            }
            .active {
                color: #666;
                background-color: #63bb66;
                text-align: center;
                text-decoration: underline;
                padding: 14px 16px;
                display: block;
            }
            .leftside, .rightside {
              height:100vh;
              width:100%
            }
         </style>

    </head>

    <body  style="background-color: #ccffeb">

      <div>
        <ul class="barra_nav">
            <li><a class="active" href="">RICETTE</a></li>
            <li><a class="active" href="/acquisti">ACQUISTI</a></li>
            <li><a class="active" href="/dispensa">DISPENSA</a></li>
        </ul>
      </div>

      <div class="container">

        <h1 style="color: #333; margin-bottom: 0px;">
            Dispensa
        </h1>
        <img src="https://raw.githubusercontent.com/andreaunitn/Dispensa/cercaRicette/Immagini/forchetta.png" style="width: 200px; height: 150px; margin-top: 0px; margin-left: 0px;">

        <br>
        <div class="row">

          <div class="col">
            <div class="leftside">

              <h3>
                  Fatti consigliare!
              </h3>
              <button class="btn1" onclick="consiglia_ricette()", id="consiglia_ricette">Consigliami</button>
              <br><br>
              <h4>
                  Ricette consigliate:
              </h4>
              <div id="lista_ricette"></div>
              <div id="ricetta_dettaglio"></div>

            </div>
          </div>
          <div class="col">
            <div class="rightside">

              <h3>
                  Inserisci il nome della ricetta
              </h3>
              <input type="text" id="titolo_ricetta">
              <button class="btn1" onclick="search_recipe()", id="submit_titolo">Cerca ricetta</button>
              <br><br>
              <h4>
                  Risultati:
              </h4>
              <div id="ricette_cercate"></div>

              <hr>

              <button class="btn1" onclick="openForm()">Aggiungi ricetta</button>

              <!-- form invio ricette -->
              <div class="form-popup" id="myForm">
                <form class="form-container">
                  <h1>Aggiungi Ricetta</h1>

                  <label><b>Titolo</b></label>
                  <input type="text" placeholder="Pizza..." id="titolo" required>

                  <label><b>Ingredienti</b></label>
                  <input type="text" placeholder="pomodoro..." id="ingrediente" required>
                  <button class="btn" onclick="add_ingredient()">Inserisci ingrediente</button>

                  <label><b>Numero persone</b></label>
                  <input type="text" placeholder="3..." id="num_per" required>

                  <label><b>Energia (kcal)</b></label>
                  <input type="text" placeholder="400 kcal..." id="energia" required>

                  <label><b>Descrizione</b></label>
                  <input type="text" placeholder="La pizza buona..." id="descrizione" required>

                  <button type="submit" class="btn" onclick="inserisci_ricetta()">Aggiungi</button>
                  <button type="button" class="btn cancel" onclick="closeForm()">Close</button>
                </form>
              </div>

            </div>
          </div>

        </div>
        <br><br>

        <hr>

      </div>

    </body>
    <script>

        ingredienti = []
        ricette_trovate = []
        ricettePerTitolo = '' //json delle ricette ottenute per titolo
        rootUrl = window.location

        //Permette al pulsante di eseguire l'azione quando viene premuto il tasto invio
        $("#ingrediente").keyup(function(event) {
            if (event.keyCode === 13) {
                $("#submit_ingredienti").click();
            }
        });

        $("#titolo_ricetta").keyup(function(event) {
            if (event.keyCode === 13) {
                $("#submit_titolo").click();
            }
        });

        function stampa_ricette_trovate() {

          var div = document.getElementById("ricette_cercate")
          var ul = document.createElement('ul')

          if (ricette_trovate != '' && ricette_trovate.length == 0 ) {
            document.getElementById('ricette_cercate').innerHTML = 'Nessuna ricetta trovata...'
          } else {
            for (var i = 0; i < ricette_trovate.length; i++) {
              const ricetta = ricette_trovate[i]

              var li = document.createElement('li')
              var a = document.createElement('a')

              var appendix = ""

              if (ricetta[2]) {
                appendix = "✅"
              }
              else {
                appendix = "❌"
              }

              a.innerHTML = ricetta[0] + " " + appendix
              a.href = window.location + "api/v1/ricette/" + ricetta[3]

              li.appendChild(a)
              var button = document.createElement("button")
              button.setAttribute("onclick","missing_ingredients(this)");
              button.id=i
              button.innerHTML="Cosa manca?"
              div=document.createElement("div")
              div.id="dettaglio_"+i
              li.appendChild(div)
              li.append(button)
              ul.appendChild(li)

            }

            var new_div = document.createElement('div')
            new_div.appendChild(ul)

            document.getElementById('ricette_cercate').innerHTML = new_div.innerHTML
          }
        }

        function cercaRicette() {

          $.ajax({
              type: 'GET',
              url: rootUrl + 'api/v1/ricette',
              data: 'ingredienti=' + JSON.stringify({ 'ingredienti': ingredienti }),
              datatype: 'json',
              success: function (data) {

                var result = data

                //Visualizzo le ricette trovate
                var div = document.getElementById("lista_ricette")
                var ul = document.createElement('ul')

                if (result.length == 0 ) {
                  document.getElementById('lista_ricette').innerHTML = 'Nessuna ricetta trovata...'
                } else {
                  for (var i = 0; i < result.length; i++) {
                    const ricetta = result.ricette[i]

                    var li = document.createElement('li')
                    var a = document.createElement('a')
                    a.innerHTML = ricetta.titolo
                    a.href = rootUrl + "api/v1/ricette/" + ricetta._id

                    li.appendChild(a)
                    ul.appendChild(li)

                  }

                  var new_div = document.createElement('div')
                  new_div.appendChild(ul)
                  //se aggiungo piu ingredienti, stampo la lista di ricette attuali e sostituisco quella precedente.
                  //fix: prima veniva appesa a quella precedente
                  document.getElementById('lista_ricette').innerHTML = new_div.innerHTML
                }
              }
          });
        }


        function consiglia_ricette() {

           //recupero da localStorage gli ingredienti e popolo l'array locale "ingredienti"
           //acquisti.html -> home.html
           if (localStorage.getItem('ingredienti')) {
             temp = localStorage.getItem('ingredienti').split(",")
             ingredienti=temp

              cercaRicette()
              feasability()

              //Rende permanente i dati
              localStorage.setItem('ingredienti', ingredienti);
           } else {
             document.getElementById("lista_ricette").innerHTML = "Niente ingredienti? niente ricette.."
           }
        }

        function cercaRicettePerTitolo(titolo) {
            $.ajax({
                type: 'GET',
                url: rootUrl + 'api/v1/ricette',
                data: 'titolo=' + titolo,
                datatype: 'json',
                success: function (data) {

                    ricettePerTitolo = data.ricette //variabile globale
                    console.log(ricettePerTitolo)

                    feasability()

                }
            })
        }

        function feasability() {

          //Ripulisco l'array prima di utilizzarlo
          ricette_trovate = []
          if (localStorage.getItem('ingredienti')) {
            ingredienti=localStorage.getItem('ingredienti').split(",")

            let ricette = ricettePerTitolo

            //Scorro tra le ricette trovate e verifico se possono essere cucinate
            for(var i = 0; i < ricette.length; i++) {
                let r = ricette[i].ingredienti
                let t = ricette[i].titolo
                let id = ricette[i]._id

                const result = r.every(val => ingredienti.includes(val));

                ricette_trovate.push([t, r, result, id])
            }

            stampa_ricette_trovate()
          } else {
            document.getElementById("ricette_cercate").innerHTML="Niente ingredienti? niente ricette..."
          }

        }

        function search_recipe() {
            const text_field = document.getElementById('titolo_ricetta')
            const titolo = text_field.value
            text_field.value = ""

            //Richiesta ajax per ottenere le ricette in base al titolo
            cercaRicettePerTitolo(titolo)
        }

        //verifico quali ingredienti mi mancano: diff tra ricettePerTitolo.ingredienti e ingredienti
        function missing_ingredients(elem) {

          ingredienti_necessari=ricette_trovate[elem.id][1]

          let difference = ingredienti_necessari.filter(x => !ingredienti.includes(x));

          console.log("missing:")
          console.log(difference)

          if (difference=='') {
            document.getElementById("dettaglio_"+elem.id).innerHTML="Niente! tutto pronto ;)"
          } else {
            document.getElementById("dettaglio_"+elem.id).innerHTML="Ti mancano: "+difference
          }

          document.getElementById(elem.id).style="visibility:hidden"

        }

        function openForm() {
            document.getElementById("myForm").style.display = "block";
          }

        function closeForm() {
            document.getElementById("myForm").style.display = "none";
          } name=""

          //Invio la ricetta per essere inserita nel DB
          function inserisci_ricetta() {
              const titolo = document.getElementById("titolo")
              const ingr = document.getElementById("ingrediente")
              const num_per = document.getElementById("num_per")
              const energia = document.getElementById("energia")
              const descrizione = document.getElementById("descrizione")

              if(titolo.value != "" && !isNaN(num_per.value)  && !isNaN(energia.value) && descrizione.value != "" && ingredienti.length != 0) {

                  console.log(titolo.value)
                  console.log(num_per.value)
                  console.log(energia.value)
                  console.log(descrizione.value)
                  console.log(ingredienti)

                  $.post('http://localhost:3000/api/v1/ricette', {
                      titolo: titolo.value,
                      ingredienti: ingredienti,
                      num_per: num_per.value,
                      energia: energia.value,
                      descrizione: descrizione.value
                    },
                    function(data, status, xhr){
                        if(xhr.status == 201) {
                          window.location.replace(xhr.getResponseHeader("location"));
                        }
                    }).fail(
                        function(jqXHR, textStatus, errorThrown) {
                          window.alert(jqXHR.status + "\n" + errorThrown);
                        }
                      );

              } else {
                  window.alert("Alcuni campi della ricetta non sono stati specificati oppure hanno un formato sbagliato")
              }

              titolo.value = ""
              ingrediente.value = ""
              num_per.value = ""
              energia.value = ""
              descrizione.value = ""
          }

          //Prendo l'ingrediente inserito lo aggiungo alla lista
          function add_ingredient() {
              const text_field = document.getElementById("ingrediente")
              const ingr = text_field.value
              text_field.value = ""

              //Se un ingrediente è già presente nella lista non lo aggiungo
              if (!ingredienti.includes(ingr) && ingr != '') {
                  ingredienti.push(ingr)
              }
          }

    </script>
</html>
