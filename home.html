<!DOCTYPE html>
<html>
    <head>
        <title>
            La Dispensa
        </title>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link rel="icon" href="https://raw.githubusercontent.com/andreaunitn/Dispensa/cercaRicette/Immagini/forchetta.png">

        <style>
            .barra_nav {
                background-color: #63bb66;
                display: flex;
                justify-content: center;
                list-style-type: none;
                margin: 0;
                padding: 0;
                overflow: hidden;
                width:100%
            }

            /* Change the link color to #111 (black) on hover */
            li a:hover {
                background-color: #111;
                color: #63bb66;
            }
            .active {
                color: #666;
                background-color: #63bb66;
                text-align: center;
                text-decoration: underline;
                padding: 14px 16px;
                display: block;
            }
            .leftside, .rightside {
              height:100vh;
              width:100%
            }
         </style>

    </head>

    <body  style="background-color: #ccffeb">

      <div>
        <ul class="barra_nav">
            <li><a class="active" href="">RICETTE</a></li>
            <li><a class="active" href="/acquisti">ACQUISTI</a></li>
            <li><a class="active" href="/dispensa">DISPENSA</a></li>
        </ul>
      </div>

      <div class="container">

        <h1 style="color: #333; margin-bottom: 0px;">
            Dispensa
        </h1>
        <img src="https://raw.githubusercontent.com/andreaunitn/Dispensa/cercaRicette/Immagini/forchetta.png" style="width: 200px; height: 150px; margin-top: 0px; margin-left: 0px;">

        <br>
        <div class="row">

          <div class="col">
            <div class="leftside">

              <h4>
                  Inserisci gli ingredienti
              </h4>
              <input type="text", id="ingrediente">
              <button onclick="add_ingredient()", id="submit">Inserisci ingrediente</button>
              <br><br>
              <h4>
                  Ingredienti:
              </h4>
              <span id="lista_ingredienti"></span>
              <br><br>
              <h4>
                  Ricette consigliate:
              </h4>
              <div id="lista_ricette"></div>
              <div id="ricetta_dettaglio"></div>

            </div>
          </div>
          <div class="col">
            <div class="rightside">

              <h4>
                  Inserisci il nome della ricetta
              </h4>
              <input type="text", id="titolo_ricetta">
              <button onclick="search_recipe()", id="submit">Cerca ricetta</button>
              <br><br>
              <h4>
                  Risultati:
              </h4>
              <div id="ricette_cercate"></div>

            </div>
          </div>

        </div>
        <br><br>

        <hr>

      </div>

    </body>
    <script>

        ingredienti = []
        ricette_trovate = []
        ricettePerTitolo = '' //json delle ricette ottenute per titolo
        rootUrl = window.location

        function stampa_ricette_trovate() {

          //var result = JSON.parse(data)
          var div = document.getElementById("ricette_cercate")
          var ul = document.createElement('ul')

          if (ricette_trovate.length == 0 ) {
            document.getElementById('ricette_cercate').innerHTML = 'Nessuna ricetta trovata...'
          } else {
            for (var i = 0; i < ricette_trovate.length; i++) {
              const ricetta = ricette_trovate[i]

              var li = document.createElement('li')
              var a = document.createElement('a')

              var appendix=""

              if (ricetta[2]) {
                appendix="✅"
              }
              else {
                appendix="❌"
              }

              a.innerHTML = ricetta[0]+" "+appendix
              a.href = window.location + "api/v1/ricette/" + ricetta[3]

              li.appendChild(a)
              ul.appendChild(li)

            }

            var new_div = document.createElement('div')
            new_div.appendChild(ul)

            document.getElementById('ricette_cercate').innerHTML = new_div.innerHTML
          }

        }

        function cercaRicette() {

          $.ajax({
              type: 'GET',
              url: rootUrl + 'api/v1/ricette',
              data: 'ingredienti=' + JSON.stringify({ 'ingredienti': ingredienti }),
              datatype: 'json',
              success: function (data) {

                var result = data

                //Visualizzo le ricette trovate
                var div = document.getElementById("lista_ricette")
                var ul = document.createElement('ul')

                if (result.length == 0 ) {
                  document.getElementById('lista_ricette').innerHTML = 'Nessuna ricetta trovata...'
                } else {
                  for (var i = 0; i < result.length; i++) {
                    const ricetta = result.ricette[i]

                    var li = document.createElement('li')
                    var a = document.createElement('a')
                    a.innerHTML = ricetta.titolo
                    a.href = rootUrl + "api/v1/ricette/" + ricetta._id

                    li.appendChild(a)
                    ul.appendChild(li)

                  }

                  var new_div = document.createElement('div')
                  new_div.appendChild(ul)
                  //se aggiungo piu ingredienti, stampo la lista di ricette attuali e sostituisco quella precedente.
                  //fix: prima veniva appesa a quella precedente
                  document.getElementById('lista_ricette').innerHTML = new_div.innerHTML
                }
              }
          });
        }

        //Prendo l'ingrediente inserito, lo aggiungo alla lista e faccio la richiesta ajax
        function add_ingredient() {
            const text_field = document.getElementById('ingrediente');
            const ingr = text_field.value
            text_field.value = ""

            //Se un ingrediente è già presente nella lista non lo aggiungo
            if(!ingredienti.includes(ingr) && ingr != '') {
                ingredienti.push(ingr)

                //Visualizzo gli ingredienti. Se premo su un ingrediente lo rimuovo dalla lista
                var span = document.getElementById('lista_ingredienti')
                var button = document.createElement('button')
                button.textContent = ingr
                button.id = ingr
                button.onclick = function () {

                    for (j = 0; j < ingredienti.length; j++) {
                        if (ingredienti[j] == ingr) {
                            ingredienti.splice(j, 1)
                            const ingr_list = document.getElementById('lista_ingredienti')
                            const i = document.getElementById(ingr)
                            ingr_list.removeChild(i)

                            cercaRicette()
                            feasability()
                            console.log(ingredienti)
                        }
                    }
                }
                span.appendChild(button)
            }

            //Richiesta ajax per ottenere le ricette
            cercaRicette()
            feasability()
            localStorage.setItem('ingredienti',ingredienti);
        }

        function cercaRicettePerTitolo(titolo) {
            $.ajax({
                type: 'GET',
                url: rootUrl + 'api/v1/ricette',
                data: 'titolo=' + titolo,
                datatype: 'json',
                success: function (data) {
                    console.log(data)


                    ricettePerTitolo = data.ricette //sì, è una variabile globale

                    feasability()

                }
            })
        }

        function feasability() {

          //Ripulisco l'array prima di utilizzarlo
          ricette_trovate = []

          let ricette = ricettePerTitolo

          //Scorro tra le ricette trovate e verifico se possono essere cucinate
          for(var i = 0; i < ricette.length; i++) {
              let r = ricette[i].ingredienti
              let t = ricette[i].titolo
              let id = ricette[i]._id

              const result = r.every(val => ingredienti.includes(val));

              ricette_trovate.push([t, r, result, id])
          }

          stampa_ricette_trovate()
        }

        function search_recipe() {
            const text_field = document.getElementById('titolo_ricetta')
            const titolo = text_field.value
            text_field.value = ""

            //Richiesta ajax per ottenere le ricette in base al titolo
            cercaRicettePerTitolo(titolo)
        }

    </script>
</html>
